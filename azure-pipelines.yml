trigger:
  - master
  - develop
  - release/*

variables:
  ArticleFull: '8866027201'
  ProjectID: 'MapStreamer'
  Major: '4'
  Minor: '2'

resources:
  repositories:
    - repository: release_templates
      type: git
      name: release_templates
      project: Common
      ref: refs/tags/2.1.3

# Build number format
name: $(ArticleFull).$(Major).$(Minor).$(rev:r)

stages:
  - stage: Build
    jobs:
      - job: Build
        workspace:
          clean: all

        pool:
          name: TS-Windows

        steps:
          - checkout: self
            lfs: true
            clean: true
            submodules: recursive
            persistCredentials: true

          - task: set-version-variables@1
            displayName: "Set version variables according to BuildNumber"
            inputs:
              setProductVersionVariable: true
              setMajorVariable: true
              setMinorVariable: true
              setBuildVariable: true
              setRevisionVariable: true
              failOnVersionSyntax: true
              defineCustomizedVariable: false

          - script: echo Version = $(Build_ProductVersion)
            displayName: "Pipeline for setting component version and change history"

          # Copy CHANGELOG to Artifacts
          - task: CopyFiles@2
            displayName: Copy CHANGELOG to Artifacts
            inputs:
              Contents: CHANGELOG.md
              TargetFolder: $(Build.ArtifactStagingDirectory)

          # Publish Artifacts
          - task: PublishBuildArtifacts@1
            displayName: Publish Artifacts
            inputs:
              PathtoPublish: $(Build.ArtifactStagingDirectory)
              ArtifactName: $(Build.BuildNumber)-$(Build.SourceBranchName)
              publishLocation: FilePath
              TargetPath: $(TSDropAreaPath)\BTA\$(Build.DefinitionName)

  # Publish tasks after approval - if branch is master or release
  - ${{ if or(eq(variables['Build.SourceBranch'], 'refs/heads/master'), startsWith(variables['Build.SourceBranch'], 'refs/heads/release/')) }}:
      # Publish release info to Wiki - https://devops.saab.se/TS/Common/_wiki/wikis/Common.wiki/1479
      - stage: PublishWiki
        displayName: Publish to Wiki
        dependsOn: Build
        jobs:
          - template: update_wiki.yml@release_templates
            parameters:
              article: $(ArticleFull)
              project: Common
              wiki: Common
              page: 1479
              changelogpath: $(Build.BuildNumber)-$(Build.SourceBranchName)/CHANGELOG.md
              publishEnvironment: PublishEnvironment
